package settings

import (
	"net/url"
	"time"
)

// AerospikeSettings configures Aerospike database connections for UTXO storage.
type AerospikeSettings struct {
	Debug                           bool          `key:"aerospike_debug" desc:"Enable Aerospike debug logging" default:"false" category:"Aerospike" usage:"Verbose logging for Aerospike operations" type:"bool" longdesc:"### Purpose\nEnables verbose debug logging for all Aerospike client operations.\n\n### How It Works\nWhen enabled, the Aerospike client outputs detailed logs including:\n- Connection pool status\n- Cluster discovery and node status changes\n- Operation timing and latencies\n- Retry attempts\n- Error details\n\n### Values\n- **false** (default) - Normal logging level\n- **true** - Verbose debug logging enabled\n\n### Recommendations\n- Enable only during troubleshooting connectivity, performance, or behavior issues\n- **Warning:** Generates significant log volume in production"`
	Host                            string        `key:"aerospike_host" desc:"Aerospike server host" default:"localhost" category:"Aerospike" usage:"Hostname or IP of Aerospike server" type:"string" longdesc:"### Purpose\nSpecifies the hostname or IP address of the Aerospike seed node for initial cluster discovery.\n\n### How It Works\nThe client uses this host to discover all cluster nodes via the Aerospike cluster-aware protocol. In multi-node clusters, specify any single node - the client auto-discovers others. Combined with aerospike_port to form the connection endpoint.\n\n### Format\n**hostname** or **IP address** - DNS names and IP addresses are both supported.\n\n### Recommendations\n- **localhost** (default) - For local development\n- Use a stable cluster node hostname or IP for production deployments"`
	BatchPolicyURL                  *url.URL      `key:"aerospike_batchPolicy" desc:"URL for batch policy configuration" default:"defaultBatchPolicy" category:"Aerospike" usage:"Custom batch operation policy" type:"url" longdesc:"### Purpose\nSpecifies the URL pointing to JSON configuration for Aerospike batch read policy, controlling behavior of multi-key read operations used extensively in UTXO lookups.\n\n### How It Works\nBatch policies control:\n- MaxConcurrentThreads - Parallel batch splits\n- AllowInline - Single-record optimization\n- SendSetName - Include set in digest\n- ReadModeAP - Read consistency level\n\n### Values\n- **defaultBatchPolicy** (default) - Uses Aerospike client defaults\n- Custom URL pointing to JSON configuration file for workload-specific optimization\n\n### Recommendations\n- Use default for most deployments\n- Custom policies can optimize for large batches or specific consistency requirements\n- Used by UTXO store for bulk transaction data fetching"`
	ReadPolicyURL                   *url.URL      `key:"aerospike_readPolicy" desc:"URL for read policy configuration" default:"defaultReadPolicy" category:"Aerospike" usage:"Custom read operation policy" type:"url" longdesc:"### Purpose\nSpecifies the URL pointing to JSON configuration for Aerospike single-record read policy, controlling consistency, timeout, and retry behavior for Get operations.\n\n### How It Works\nRead policies control:\n- ReadModeAP / ReadModeSC - Consistency level\n- TotalTimeout - Overall operation timeout\n- SocketTimeout - Socket-level timeout\n- MaxRetries - Retry attempts\n- SleepBetweenRetries - Delay between retries\n\n### Values\n- **defaultReadPolicy** (default) - Uses client defaults suitable for most workloads\n- Custom URL for specific consistency or performance requirements\n\n### Recommendations\n- **Strong consistency:** Use ReadModeSC=SESSION\n- **Relaxed reads:** Use ReadModeAP=ONE\n- Used for individual UTXO and transaction metadata lookups"`
	WritePolicyURL                  *url.URL      `key:"aerospike_writePolicy" desc:"URL for write policy configuration" default:"defaultWritePolicy" category:"Aerospike" usage:"Custom write operation policy" type:"url" longdesc:"### Purpose\nSpecifies the URL pointing to JSON configuration for Aerospike write policy, controlling durability, timeout, and behavior for Put/Delete operations.\n\n### How It Works\nWrite policies control:\n- CommitLevel - COMMIT_ALL vs COMMIT_MASTER\n- RecordExistsAction - UPDATE, REPLACE, CREATE_ONLY\n- GenerationPolicy - Version control behavior\n- Expiration - Record TTL\n- TotalTimeout - Overall operation timeout\n\n### Values\n- **defaultWritePolicy** (default) - Uses client defaults with COMMIT_ALL for durability\n- Custom URL for write-heavy workloads or relaxed durability requirements\n\n### Recommendations\n- Use default for most deployments requiring strong durability\n- Used for storing new UTXOs and updating transaction metadata"`
	QueryPolicyURL                  *url.URL      `key:"aerospike_queryPolicy" desc:"URL for query policy configuration" default:"defaultQueryPolicy" category:"Aerospike" usage:"Custom query operation policy" type:"url" longdesc:"### Purpose\nSpecifies the URL pointing to JSON configuration for Aerospike query policy, controlling behavior of secondary index queries and scan operations.\n\n### How It Works\nQuery policies control:\n- MaxConcurrentNodes - Parallel node queries\n- RecordQueueSize - Result buffering size\n- IncludeBinData - Return full records vs keys only\n- FailOnClusterChange - Abort on topology changes\n\n### Values\n- **defaultQueryPolicy** (default) - Uses client defaults\n- Custom URL for full-table scans or selective query optimization\n\n### Recommendations\n- Less commonly used in Teranode since most UTXO access is by primary key\n- May be useful for administrative operations or batch processing"`
	Port                            int           `key:"aerospike_port" desc:"Aerospike server port" default:"3000" category:"Aerospike" usage:"Port number for Aerospike connections" type:"int" longdesc:"### Purpose\nSpecifies the TCP port number for Aerospike server connections, combined with aerospike_host to form the complete connection endpoint.\n\n### How It Works\nThe client connects to the specified port on the seed host, then discovers peer ports automatically after initial connection.\n\n### Values\n- **3000** (default) - Standard Aerospike service port\n- 3001 - Mesh heartbeat port\n- 3002 - Fabric (inter-node communication) port\n\n### Recommendations\n- Ensure firewall rules allow TCP traffic on this port\n- In containerized environments, map to the container's exposed port\n- All cluster nodes typically use the same port"`
	UseDefaultBasePolicies          bool          `key:"aerospike_useDefaultBasePolicies" desc:"Use default base policy settings" default:"false" category:"Aerospike" usage:"Apply default timeouts and retries" type:"bool" longdesc:"### Purpose\nControls whether to use the Aerospike client's built-in default base policy for all operations.\n\n### How It Works\nBase policy parameters include:\n- Priority - Operation priority\n- TotalTimeout - Overall timeout\n- SocketTimeout - Socket-level timeout\n- MaxRetries - Retry attempts\n- SleepBetweenRetries - Delay between retries\n- SendKey - Include key in request\n- UseCompression - Enable compression\n\nOperation-specific policies (Read/Write/Batch/Query) override these base settings.\n\n### Values\n- **false** (default) - Teranode sets explicit policy values\n- **true** - Use Aerospike client defaults\n\n### Recommendations\n- Keep disabled to ensure consistent behavior across Aerospike client upgrades\n- Enable only when Aerospike client defaults are specifically preferred"`
	UseDefaultPolicies              bool          `key:"aerospike_useDefaultPolicies" desc:"Use default operation policies" default:"false" category:"Aerospike" usage:"Apply built-in operation policies" type:"bool" longdesc:"### Purpose\nControls whether to use the Aerospike client's built-in default policies for all operation types.\n\n### How It Works\nAffects all operation types:\n- Read operations\n- Write operations\n- Batch operations\n- Query operations\n\n**Important:** Mutually exclusive with custom policy URLs - if enabled, policy URLs are ignored.\n\n### Values\n- **false** (default) - Teranode configures custom policies via policy URL settings\n- **true** - Use Aerospike client defaults for all operations\n\n### Recommendations\n- Keep disabled for production to maintain explicit control over operation behavior\n- Enable for testing environments or when Aerospike client defaults are preferred"`
	WarmUp                          bool          `key:"aerospike_warmUp" desc:"Warm up connection pool on startup" default:"true" category:"Aerospike" usage:"Pre-establish connections at initialization" type:"bool" longdesc:"### Purpose\nControls whether to pre-establish connections to the Aerospike cluster during client initialization.\n\n### How It Works\nWhen enabled, warmup performs:\n- Creates connections up to ConnectionQueueSize per node\n- Performs cluster discovery\n- Validates connectivity\n- Populates connection pool\n\nStartup fails if warmup cannot connect, providing early failure detection.\n\n### Values\n- **true** (default) - Pre-establish connections at startup\n- **false** - Lazy connection establishment\n\n### Recommendations\n- Enable for production to ensure cluster availability before accepting traffic\n- Disable for faster startup in development or when Aerospike is not immediately needed"`
	StoreBatcherDuration            time.Duration `key:"aerospike_storeBatcherDuration" desc:"Batch collection duration for store operations" default:"10ms" category:"Aerospike" usage:"Time window for batching writes" type:"duration" longdesc:"### Purpose\nSets the duration to collect individual write operations before sending as a batch to Aerospike.\n\n### How It Works\nAccumulates writes for up to the specified duration then flushes as a single batch operation. Works with batcher size limits - flushes when **either** duration or size threshold is reached first. Used by UTXO store for efficient bulk writes.\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Lower (1-5ms) | Reduced latency | Higher operation count |\n| Higher (20-50ms) | Improved throughput | Added latency |\n\n### Recommendations\n- **10ms** (default) - Balanced for most workloads\n- Use 1-5ms for low-latency requirements\n- Use 20-50ms for high-throughput scenarios"`
	StatsRefreshDuration            time.Duration `key:"aerospike_statsRefresh" desc:"Statistics refresh interval" default:"5s" category:"Aerospike" usage:"How often to refresh cluster statistics" type:"duration" longdesc:"### Purpose\nSets the interval for refreshing Aerospike cluster statistics and metrics.\n\n### How It Works\nPeriodically collects and exposes metrics including:\n- Connection pool utilization\n- Node status\n- Operation latencies\n- Error counts\n- Memory usage\n\nStatistics are exposed via Prometheus metrics for monitoring dashboards, including per-node and aggregate cluster metrics.\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Lower | More current data | Higher overhead |\n| Higher | Reduced overhead | May miss transient issues |\n\n### Recommendations\n- **5s** (default) - Good balance for production monitoring\n- Critical for health checks and alerting to detect cluster problems before they impact service"`
	EnableSpendFilterExpressions    bool          `key:"aerospike_enable_spend_filter_expressions" desc:"Enable filter expressions for spend operations" default:"false" category:"Aerospike" usage:"Use server-side filtering for UTXO spends" type:"bool" longdesc:"### Purpose\nControls whether to use Aerospike filter expressions for spend operations, enabling server-side filtering of records.\n\n### How It Works\nFilter expressions allow server-side filtering during read/update operations, reducing network transfer and client processing. Expressions evaluate on the server, returning only matching records.\n\n**Requirement:** Aerospike Enterprise Edition 4.7+ for full expression support.\n\n### Values\n- **false** (default) - Uses traditional client-side filtering\n- **true** - Uses server-side filter expressions\n\n### Recommendations\n- Enable for performance improvement when spending UTXOs with specific criteria\n- Particularly effective for high-cardinality filtering scenarios\n- **Test thoroughly** before enabling in production as behavior differs from client-side filtering"`
	EnableSetMinedFilterExpressions bool          `key:"aerospike_enable_setmined_filter_expressions" desc:"Enable filter expressions for set mined operations" default:"false" category:"Aerospike" usage:"Use server-side filtering for mined status updates" type:"bool" longdesc:"### Purpose\nControls whether to use Aerospike filter expressions for set-mined operations that mark transactions as included in blocks.\n\n### How It Works\nSimilar to EnableSpendFilterExpressions but for the mined status update path. Works with UseSeparateUDFMinedModule for additional optimization. Server-side expressions reduce round-trips and network transfer.\n\n**Requirement:** Aerospike Enterprise Edition 4.7+\n\n### Values\n- **false** (default) - Uses traditional approach\n- **true** - Uses server-side filter expressions\n\n### Recommendations\n- Enable for performance improvement when updating large batches of transaction mined status\n- **Evaluate impact on write latency** before enabling in production"`
	UseSeparateUDFMinedModule       bool          `key:"aerospike_use_separate_udf_mined_module" desc:"Use separate UDF module for mined operations" default:"false" category:"Aerospike" usage:"Isolate mined status UDFs" type:"bool" longdesc:"### Purpose\nControls whether to use a separate User Defined Function (UDF) module for mined status operations.\n\n### How It Works\nUDFs are Lua scripts that run on Aerospike server for complex atomic operations. Separation provides:\n- Isolated mined status logic\n- Independent updates capability\n- Reduced risk of UDF changes affecting other operations\n- Modules can be version-controlled and deployed independently\n\n**Requirement:** Requires UDF module deployment to Aerospike cluster.\n\n### Values\n- **false** (default) - Uses shared UDF module\n- **true** - Uses separate UDF module for mined operations\n\n### Recommendations\n- Enable in large deployments where mined status updates are performance-critical\n- Useful when mined operations need different optimization than other UTXO operations"`
	SeparateSpendUDFModuleCount     int           `key:"aerospike_separate_udf_spend_module_count" desc:"Number of separate UDF modules for spend operations" default:"0" category:"Aerospike" usage:"Distribute spend operations across UDF modules" type:"int" longdesc:"### Purpose\nControls the number of separate UDF modules to distribute spend operations across for reducing contention.\n\n### How It Works\nEach module handles 1/N of spend operations based on consistent hashing. Reduces UDF contention in high-throughput scenarios where spend operations are the bottleneck.\n\n**Requirement:** Requires deploying multiple UDF modules to Aerospike cluster.\n\n### Values\n- **0** (default) - Uses single shared module\n- **N > 0** - Spreads spend operations across N UDF modules (e.g., 4, 8)\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Higher | Reduced per-module contention | Increased deployment complexity |\n| Lower | Simpler deployment | Potential contention bottleneck |\n\n### Recommendations\n- Monitor UDF execution times to determine if module sharding provides benefit\n- Typically only needed for extremely high transaction volumes"`
}
