package settings

import "time"

// PropagationSettings configures the transaction propagation service.
type PropagationSettings struct {
	IPv6Addresses        string        `key:"ipv6_addresses" desc:"IPv6 addresses for propagation" default:"" category:"Propagation" usage:"Enable IPv6 propagation" type:"string" longdesc:"### Purpose\nEnables high-performance transaction broadcast over IPv6 networks using UDP multicast, which is significantly faster than TCP-based protocols for one-to-many communication.\n\n### How It Works\n- Transactions are broadcast to all specified IPv6 multicast addresses simultaneously\n- UDP multicast provides efficient one-to-many communication without TCP connection overhead\n- Each address runs a listener on port 9999 that receives and processes incoming transactions\n\n### Format\nComma-separated list of IPv6 multicast addresses.\n\n### Recommendations\n- Leave empty for simple deployments using gRPC/HTTP only\n- Configure for production multi-node setups requiring maximum throughput\n- Ensure network infrastructure supports IPv6 multicast before enabling"`
	IPv6Interface        string        `key:"ipv6_interface" desc:"Network interface for IPv6 propagation" default:"" category:"Propagation" usage:"Interface name for IPv6 traffic" type:"string" longdesc:"### Purpose\nSpecifies which network interface handles IPv6 multicast propagation traffic.\n\n### How It Works\nWhen IPv6 propagation is enabled, the system binds multicast listeners to this specific network interface. If not specified, defaults to **en0**.\n\n### Format\nNetwork interface name (e.g., eth0, ens5, bond0).\n\n### Recommendations\n- Use **eth0** for standard Linux deployments\n- Use **ens5** for AWS/cloud network interfaces\n- Use **bond0** for bonded network configurations\n- Must be set when **ipv6_addresses** is configured\n- Interface must have IPv6 enabled and support multicast"`
	GRPCMaxConnectionAge time.Duration `key:"propagation_grpcMaxConnectionAge" desc:"Maximum age for gRPC connections" default:"90s" category:"Propagation" usage:"Recycle connections after this duration" type:"duration" longdesc:"### Purpose\nPeriodically refreshes gRPC connections to ensure proper load balancer distribution and prevent stale connections.\n\n### How It Works\nConnections older than this duration are gracefully closed, forcing clients to reconnect. This triggers load balancer rebalancing and clears any connection state that may have degraded.\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Shorter (30-60s) | Better load distribution | More connection overhead |\n| Longer (5m+) | Less overhead | Potential for uneven load distribution |\n\n### Recommendations\n- **90s** (default) - Good balance for most deployments\n- Reduce to **30-60s** in highly dynamic environments with frequent scaling\n- Increase to **5m+** for stable, low-traffic deployments"`
	HTTPListenAddress    string        `key:"propagation_httpListenAddress" desc:"HTTP listen address for Propagation service" default:"" category:"Propagation" usage:"Alternative HTTP interface for propagation" type:"string" longdesc:"### Purpose\nConfigures the HTTP/REST endpoint for transaction submission as an alternative to gRPC.\n\n### How It Works\n- Starts an Echo HTTP server with endpoints for single (/tx) and batch (/txs) transaction submission\n- Includes a health check endpoint (/health)\n- Applies rate limiting based on **propagation_httpRateLimit** setting\n\n### Format\n- **:port** - Listen on all interfaces (e.g., :8080)\n- **ip:port** - Listen on specific interface (e.g., 127.0.0.1:8080)\n\n### Recommendations\n- Leave empty if only gRPC is needed\n- Configure for clients without gRPC support\n- Use specific IP binding in multi-homed servers for security"`
	HTTPAddresses        []string      `key:"propagation_httpAddresses" desc:"HTTP addresses for propagation (pipe-separated)" default:"" category:"Propagation" usage:"List of HTTP propagation endpoints" type:"[]string" longdesc:"### Purpose\nDefines downstream HTTP endpoints for transaction propagation to validator services.\n\n### How It Works\n- Used as the primary transport when **propagation_alwaysUseHTTP** is enabled\n- Serves as automatic fallback when transactions exceed gRPC message size limits\n- First address in the list is used for HTTP propagation\n\n### Format\nPipe-separated list of HTTP URLs (e.g., http://validator1:8080|http://validator2:8080).\n\n### Recommendations\n- Configure at least one HTTP address for large transaction fallback\n- Use internal DNS names in containerized environments\n- Ensure endpoints point to healthy validator instances"`
	AlwaysUseHTTP        bool          `key:"propagation_alwaysUseHTTP" desc:"Always use HTTP instead of gRPC for propagation" default:"false" category:"Propagation" usage:"Enable if gRPC is not available" type:"bool" longdesc:"### Purpose\nForces all transaction propagation to use HTTP instead of gRPC.\n\n### How It Works\n- When enabled, bypasses gRPC entirely and sends all transactions via HTTP POST to the configured HTTP addresses\n- When disabled, uses gRPC as primary transport with automatic HTTP fallback for oversized transactions\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| false (gRPC) | Higher performance, streaming support | Requires HTTP/2, complex proxying |\n| true (HTTP) | Simpler setup, broader compatibility | Lower throughput |\n\n### Recommendations\n- **false** (default) - Use gRPC for optimal performance\n- Enable when firewalls block gRPC/HTTP2 traffic\n- Enable when proxy servers lack gRPC support"`
	HTTPRateLimit        int           `key:"propagation_httpRateLimit" desc:"Rate limit for HTTP propagation requests" default:"1024" category:"Propagation" usage:"Requests per second limit" type:"int" longdesc:"### Purpose\nProtects the HTTP propagation endpoint against abuse, DoS attacks, and ensures fair resource usage.\n\n### How It Works\n- Uses in-memory rate limiter middleware on the HTTP server\n- Requests exceeding the limit are rejected with HTTP 429 (Too Many Requests)\n- Set to 0 to disable rate limiting entirely\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Higher | More throughput | Higher resource usage, less protection |\n| Lower | Better protection | May throttle legitimate traffic |\n\n### Recommendations\n- **1024** (default) - Suitable for most deployments\n- Increase for high-throughput production environments\n- Decrease if experiencing resource exhaustion"`
	SendBatchSize        int           `key:"propagation_sendBatchSize" desc:"Batch size for sending transactions" default:"100" category:"Propagation" usage:"Larger batches improve throughput" type:"int" longdesc:"### Purpose\nControls how many transactions are batched together before sending to downstream services.\n\n### How It Works\n- Transactions are queued until the batch size is reached or **propagation_sendBatchTimeout** expires\n- Batching reduces network overhead by combining multiple transactions into single gRPC/HTTP calls\n- Set to 0 to disable batching and process transactions immediately\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Larger (500-1000) | Higher throughput, reduced overhead | Increased latency per transaction |\n| Smaller (10-50) | Lower latency per transaction | More network overhead |\n\n### Recommendations\n- **100** (default) - Good balance for most scenarios\n- Increase to **500-1000** for high-volume production environments\n- Decrease to **10-50** when low latency is critical"`
	SendBatchTimeout     int           `key:"propagation_sendBatchTimeout" desc:"Timeout in milliseconds for batch sending" default:"5" category:"Propagation" usage:"How long to wait before sending partial batch" type:"int" longdesc:"### Purpose\nEnsures transactions are sent in a timely manner even when the batch size is not reached.\n\n### How It Works\n- If **propagation_sendBatchSize** is not reached within this timeout, the current batch is sent regardless of size\n- Prevents indefinite waiting during low-traffic periods\n- Value is in milliseconds\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Shorter (1-2ms) | Lower latency | More frequent smaller batches |\n| Longer (10-30ms) | Better batching efficiency | Higher latency during low traffic |\n\n### Recommendations\n- **5** (default) - Good balance for most scenarios\n- Reduce to **1-2** for latency-sensitive applications\n- Increase to **10-30** for batch-optimized high-throughput scenarios"`
	GRPCAddresses        []string      `key:"propagation_grpcAddresses" desc:"gRPC addresses for propagation (pipe-separated)" default:"" category:"Propagation" usage:"List of gRPC propagation endpoints" type:"[]string" longdesc:"### Purpose\nDefines downstream gRPC endpoints for transaction propagation to validator services.\n\n### How It Works\n- The propagation client connects to the first address in the list\n- Transactions are sent via gRPC with automatic HTTP fallback for oversized messages\n- Connection uses configured retry and backoff settings from global gRPC settings\n\n### Format\nPipe-separated list of host:port addresses (e.g., validator1:8081|validator2:8081).\n\n### Recommendations\n- Configure at least one address for gRPC propagation\n- Use internal DNS names in containerized environments\n- Ensure endpoints point to healthy validator instances"`
	GRPCListenAddress    string        `key:"propagation_grpcListenAddress" desc:"gRPC listen address for Propagation service" default:"" category:"Propagation" usage:"Port for transaction propagation" type:"string" longdesc:"### Purpose\nConfigures the server binding address where the propagation service accepts incoming gRPC connections.\n\n### How It Works\n- Starts a gRPC server that accepts ProcessTransaction and ProcessTransactionBatch requests\n- Connection age is managed by **propagation_grpcMaxConnectionAge** for load balancer compatibility\n- Includes a HealthGRPC endpoint for service health monitoring\n\n### Format\n- **:port** - Listen on all interfaces (e.g., :8080)\n- **ip:port** - Listen on specific interface (e.g., 127.0.0.1:8080)\n\n### Recommendations\n- Use **:port** format in containerized environments\n- Bind to specific IP in multi-homed servers for security\n- Ensure port is accessible from all transaction sources"`
}
