package settings

import "net/url"

// ValidatorSettings configures the transaction validation service.
type ValidatorSettings struct {
	GRPCAddress               string   `key:"validator_grpcAddress" desc:"gRPC address for Validator service" default:"localhost:8081" category:"Validator" usage:"Address for inter-service communication" type:"string" longdesc:"### Purpose\nSpecifies the client connection address for the Validator gRPC service.\n\n### How It Works\nOther services use this address to connect to the Validator for transaction validation requests. The Validator is a critical service that handles all transaction validation in the system.\n\n### Format\n**host:port** - Where host is a hostname, IP address, or DNS name.\n\n### Examples\n- **localhost:8081** - Local development (default)\n- **validator.internal:8081** - Internal DNS\n- **10.0.1.50:8081** - Direct IP address\n\n### Recommendations\n- Use internal DNS or service mesh addresses in production\n- Use localhost only for local development\n- For horizontal scaling, use a load balancer address"`
	GRPCListenAddress         string   `key:"validator_grpcListenAddress" desc:"gRPC listen address for Validator service" default:":8081" category:"Validator" usage:"Port for incoming gRPC connections" type:"string" longdesc:"### Purpose\nSpecifies the server binding address for the Validator gRPC service.\n\n### How It Works\nThe Validator service listens on this address for incoming gRPC requests from other services. This is a critical service that handles all transaction validation.\n\n### Format\n- **:port** - Binds to all network interfaces\n- **ip:port** - Binds to a specific interface\n\n### Examples\n- **:8081** - Listen on all interfaces (default)\n- **127.0.0.1:8081** - Listen only on localhost\n- **10.0.1.50:8081** - Listen on specific interface\n\n### Recommendations\n- Use **:port** format for containerized deployments\n- Bind to specific IP for security in multi-tenant environments\n- Multiple instances can run for horizontal scaling"`
	KafkaWorkers              int      `key:"validator_kafkaWorkers" desc:"Number of Kafka consumer workers" default:"0" category:"Validator" usage:"Parallel Kafka message processors" type:"int" longdesc:"### Purpose\nControls the number of goroutines consuming messages from the Kafka validation topic.\n\n### How It Works\n- Each worker processes messages from Kafka partitions independently\n- Workers share connection pools to other services\n- Auto-scaling distributes workers across available partitions\n\n### Values\n- **0** (default) - Automatic scaling based on partition count and system resources\n- **N > 0** - Fixed number of workers for deterministic resource allocation\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Higher | Increased parallelism | More CPU usage |\n| Lower | Reduced resource usage | Less parallelism |\n\n### Recommendations\n- Use **0** for most deployments to leverage auto-scaling\n- Set explicitly in production for deterministic resource allocation"`
	SendBatchSize             int      `key:"validator_sendBatchSize" desc:"Batch size for sending validated transactions" default:"100" category:"Validator" usage:"Transactions per batch to downstream" type:"int" longdesc:"### Purpose\nControls how many validated transactions are batched before sending to Block Assembly.\n\n### How It Works\nValidated transactions are collected in a batch. When the batch reaches this size or the timeout expires (whichever comes first), the batch is sent to downstream services.\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Higher | Reduced gRPC overhead, higher throughput | Increased latency |\n| Lower | Lower latency | More gRPC calls, higher overhead |\n\n### Recommendations\n- **100** (default) - Good balance between latency and efficiency\n- Increase for high-throughput scenarios where latency is less critical\n- Decrease for low-latency requirements\n- Works with SendBatchTimeout - whichever limit is reached first triggers send"`
	SendBatchTimeout          int      `key:"validator_sendBatchTimeout" desc:"Timeout for batch sending in milliseconds" default:"2" category:"Validator" usage:"Maximum wait before sending partial batch" type:"int" longdesc:"### Purpose\nSets the maximum time to wait for a batch to fill before sending a partial batch.\n\n### How It Works\nDuring low traffic, batches may not fill completely. This timeout ensures validated transactions are sent promptly rather than waiting indefinitely.\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Lower | Reduced latency | More small batches, higher overhead |\n| Higher | Better batching efficiency | Higher latency during low traffic |\n\n### Recommendations\n- **2** (default) - Good balance for most deployments\n- Decrease for lower latency requirements\n- Works with SendBatchSize - whichever limit is reached first triggers send"`
	SendBatchWorkers          int      `key:"validator_sendBatchWorkers" desc:"Number of batch sender workers" default:"10" category:"Validator" usage:"Parallel batch send goroutines" type:"int" longdesc:"### Purpose\nControls the number of goroutines sending validated transaction batches to downstream services.\n\n### How It Works\nMultiple workers send batches concurrently, allowing higher throughput especially when downstream services have latency.\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Higher | Better throughput with downstream latency | More memory and connections |\n| Lower | Reduced resource usage | Potential bottleneck during high load |\n\n### Recommendations\n- **10** (default) - Good parallelism without excessive resource usage\n- Increase if downstream services (Block Assembly) have high latency\n- Decrease in memory-constrained environments"`
	BlockValidationDelay      int      `key:"validator_blockvalidation_delay" desc:"Delay before block validation in milliseconds" default:"0" category:"Validator" usage:"Artificial delay for testing" type:"int" longdesc:"### Purpose\nAdds an artificial delay in milliseconds before validating blocks.\n\n### Warning\n**TESTING ONLY** - This setting should never be used in production. It exists solely for testing timeout handling and simulating slow validation scenarios.\n\n### Values\n- **0** (default) - No delay (required for production)\n- **N > 0** - Artificial delay in milliseconds (testing only)\n\n### Recommendations\n- Always use **0** in production\n- Use non-zero values only for chaos engineering or integration testing"`
	BlockValidationMaxRetries int      `key:"validator_blockvalidation_maxRetries" desc:"Maximum retries for block validation" default:"5" category:"Validator" usage:"Retries on transient failures" type:"int" longdesc:"### Purpose\nControls maximum retry attempts for block validation operations on transient failures.\n\n### How It Works\n- Applies to transient failures: network timeouts, temporary unavailability, recoverable errors\n- Permanent failures (invalid blocks) fail immediately without retry\n- Uses exponential backoff between attempts (see BlockValidationRetrySleep)\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Higher | Better reliability in unstable environments | Longer total failure time |\n| Lower | Faster failure detection | May fail on recoverable issues |\n\n### Recommendations\n- **5** (default) - Good reliability without excessive waiting\n- Increase for unreliable networks\n- Decrease for faster failure detection in stable environments"`
	BlockValidationRetrySleep string   `key:"validator_blockvalidation_retrySleep" desc:"Sleep duration between validation retries" default:"2s" category:"Validator" usage:"Backoff between retry attempts" type:"string" longdesc:"### Purpose\nSets the base sleep duration between block validation retry attempts.\n\n### How It Works\nAfter a transient failure, the service waits this duration before attempting again. Actual delay may use exponential backoff multiplier for subsequent retries.\n\n### Format\nGo duration string (e.g., 2s, 500ms, 1m)\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Shorter | Faster recovery | Higher load during outages |\n| Longer | Reduced load | Slower recovery |\n\n### Recommendations\n- **2s** (default) - Good balance for most environments\n- Increase for systems with longer recovery times"`
	VerboseDebug              bool     `key:"validator_verbose_debug" desc:"Enable verbose debug logging" default:"false" category:"Validator" usage:"Detailed validation logging" type:"bool" longdesc:"### Purpose\nEnables verbose debug logging for transaction validation operations.\n\n### How It Works\nWhen enabled, logs detailed information about each validation including entry and exit points with transaction IDs.\n\n### Warning\nGenerates **high log volume** - enable only during troubleshooting. This can significantly impact performance and disk usage.\n\n### Values\n- **false** (default) - Normal logging\n- **true** - Verbose debug logging enabled\n\n### Recommendations\n- Keep disabled in production\n- Enable temporarily for debugging validation failures or understanding rejection reasons"`
	HTTPListenAddress         string   `key:"validator_httpListenAddress" desc:"HTTP listen address for Validator" default:"" category:"Validator" usage:"REST API endpoint" type:"string" longdesc:"### Purpose\nSpecifies the HTTP listen address for the Validator REST API.\n\n### How It Works\nThe Validator can expose an HTTP endpoint as an alternative to gRPC. This is used as a fallback for large transactions that exceed Kafka message size limits.\n\n### Format\n- **:port** - Binds to all network interfaces\n- **ip:port** - Binds to a specific interface\n- **empty** - Disables HTTP endpoint\n\n### Values\n- **empty** (default) - HTTP endpoint disabled\n- **:8082** - Listen on all interfaces on port 8082\n- **127.0.0.1:8082** - Listen only on localhost\n\n### Recommendations\n- Enable when handling large transactions that exceed Kafka limits\n- Configure HTTPAddress to provide the client connection URL"`
	HTTPAddress               *url.URL `key:"validator_httpAddress" desc:"HTTP address for Validator clients" default:"" category:"Validator" usage:"Client connection URL" type:"url" longdesc:"### Purpose\nSpecifies the HTTP URL for clients to connect to the Validator REST API.\n\n### How It Works\nOther services (like Propagation) use this URL to send large transactions that exceed Kafka message size limits directly to the Validator via HTTP.\n\n### Format\n**http://host:port** - Full URL with protocol, host, and port.\n\n### Values\n- **empty** (default) - HTTP endpoint not available\n- **http://localhost:8082** - Local development\n- **http://validator.internal:8082** - Internal DNS\n\n### Recommendations\n- Configure to match HTTPListenAddress but with a resolvable hostname\n- Required when HTTPListenAddress is set"`
	HTTPRateLimit             int      `key:"validator_httpRateLimit" desc:"Rate limit for HTTP requests" default:"1024" category:"Validator" usage:"Maximum requests per second" type:"int" longdesc:"### Purpose\nSets the maximum HTTP requests per second allowed to the Validator REST API.\n\n### How It Works\nUses an in-memory rate limiter to control request throughput. Requests exceeding the limit receive HTTP 429 (Too Many Requests) responses.\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Higher | More throughput | Less DoS protection |\n| Lower | Better protection | May throttle legitimate traffic |\n\n### Recommendations\n- **1024** (default) - Suitable for moderate traffic\n- Increase for high-throughput deployments\n- Decrease for resource-constrained environments or stronger DoS protection"`
	KafkaMaxMessageBytes      int      `key:"validator_kafka_maxMessageBytes" desc:"Maximum Kafka message size in bytes" default:"1048576" category:"Validator" usage:"Limit for single Kafka message" type:"int" longdesc:"### Purpose\nSets the maximum size in bytes for a single Kafka message sent to the validation topic.\n\n### How It Works\nTransactions are serialized and sent to Kafka for validation. If a transaction exceeds this size, it falls back to the HTTP endpoint instead of Kafka.\n\n### Values\n- **1048576** (default) - 1MB, matches Kafka broker defaults\n\n### Warning\n**Must match** Kafka broker message.max.bytes configuration. Mismatched values will cause message delivery failures.\n\n### Recommendations\n- Keep aligned with Kafka broker configuration\n- Configure HTTPListenAddress as fallback for large transactions\n- Larger values require more memory for buffering"`
	UseLocalValidator         bool     `key:"useLocalValidator" desc:"Use local in-process validator" default:"false" category:"Validator" usage:"Skip gRPC for validation" type:"bool" longdesc:"### Purpose\nEnables in-process validator instead of making gRPC calls to a remote Validator service.\n\n### How It Works\nWhen enabled, validation is performed directly in-process, eliminating network overhead. When disabled, validation requests are sent to a remote Validator service via gRPC.\n\n### Values\n- **false** (default) - Uses distributed gRPC validator\n- **true** - Uses in-process validator\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Enabled | No network overhead, simpler setup | Cannot scale validator independently |\n| Disabled | Independent scaling, distributed processing | Network latency |\n\n### Recommendations\n- **false** for production distributed deployments\n- **true** for testing, development, or single-machine deployments"`
	TxMetaKafkaBatchSize      int      `key:"validator_txmeta_kafka_batchSize" desc:"Batch size for Kafka transaction metadata" default:"1024" category:"Validator" usage:"Messages per Kafka batch" type:"int" longdesc:"### Purpose\nControls how many transaction metadata messages are batched before sending to Kafka.\n\n### How It Works\nTransaction metadata is collected in a batch. When the batch reaches this size or the timeout expires (whichever comes first), the batch is sent to Kafka.\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Higher | Reduced Kafka overhead | Increased memory and latency |\n| Lower | Faster metadata availability | More Kafka operations |\n\n### Recommendations\n- **1024** (default) - Good balance between latency and throughput\n- Works with TxMetaKafkaBatchTimeoutMs - whichever limit is reached first triggers send"`
	TxMetaKafkaBatchTimeoutMs int      `key:"validator_txmeta_kafka_batchTimeoutMs" desc:"Timeout for Kafka batch in milliseconds" default:"5" category:"Validator" usage:"Maximum wait for batch to fill" type:"int" longdesc:"### Purpose\nSets the maximum time in milliseconds to wait for a transaction metadata batch to fill before sending.\n\n### How It Works\nDuring low traffic, batches may not fill completely. This timeout ensures metadata is published promptly rather than waiting indefinitely.\n\n### Trade-offs\n| Setting | Benefit | Drawback |\n|---------|---------|----------|\n| Lower | Faster metadata availability | More Kafka operations |\n| Higher | Better batching efficiency | Higher latency during low traffic |\n\n### Recommendations\n- **5** (default) - Ensures prompt metadata publishing\n- Works with TxMetaKafkaBatchSize - whichever limit is reached first triggers send"`
}
